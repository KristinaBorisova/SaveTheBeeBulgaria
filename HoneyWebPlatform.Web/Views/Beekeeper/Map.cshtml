@model BeekeepersMapViewModel

@{
    ViewBag.Title = "Интерактивна карта на Пчелари";
}

<style>
    .map-container {
        width: 100%;
        height: 80vh;
        position: relative;
    }

    .map-filters {
        background: white;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .filter-row {
        display: flex;
        gap: 1rem;
        align-items: end;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }

    .filter-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
    }

    .filter-group select:hover {
        border-color: #F59F0A;
    }

    .search-btn {
        padding: 0.75rem 1.5rem;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
    }

    .search-btn:hover {
        background: #5a6268;
    }

    .clear-filters-btn {
        padding: 0.75rem 1.5rem;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
    }

    .clear-filters-btn:hover {
        background: #c82333;
    }

    .beekeeper-info-window {
        padding: 1rem;
    }

    .beekeeper-info-window h3 {
        margin: 0 0 0.5rem 0;
        color: #F59F0A;
        font-size: 1.2rem;
    }

    .beekeeper-info-window p {
        margin: 0.25rem 0;
        color: #666;
    }

    .beekeeper-info-window a {
        display: inline-block;
        margin-top: 0.75rem;
        padding: 0.5rem 1rem;
        background: #F59F0A;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-weight: 600;
        border: 1px solid transparent;
        transition: all 0.3s;
    }

    .beekeeper-info-window a:hover {
        background: white;
        color: #F59F0A;
        border: 1px solid #F59F0A;
    }

    .honey-types {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-top: 0.5rem;
    }

    .honey-type-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: #e8f5e9;
        color: #2e7d32;
        border-radius: 3px;
        font-size: 0.85rem;
    }

    #map {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        height: 100%;
        min-height: 500px;
    }

    .map-page-container {
        padding: 2rem 0;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-header h1 {
        font-size: 2.5rem;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .page-header p {
        color: #666;
        font-size: 1.1rem;
    }

    @@media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
        }

        .filter-group {
            min-width: 100%;
        }

        .page-header h1 {
            font-size: 2rem;
        }

        .map-container {
            height: 70vh;
        }
    }
</style>

<div class="map-page-container">
    <div class="container">
        <div class="page-header">
            <h1>Интерактивна карта на Пчелари</h1>
            <p>Намерете пчелари в България и опознайте качествата им мед</p>
        </div>

        <div class="map-filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="regionFilter">Филтрирай по регион:</label>
                    <select id="regionFilter">
                        <option value="">Всички региони</option>
                        <option value="Северозападен">Северозападен (Враца, Монтана, Видин, Плевен, Ловеч)</option>
                        <option value="Северен централен">Северен централен (Русе, Разград, Шумен, Търговище, Силистра, Добрич)</option>
                        <option value="Североизточен">Североизточен (Варна)</option>
                        <option value="Югозападен">Югозападен (София, Перник, Кюстендил, Благоевград)</option>
                        <option value="Южен централен">Южен централен (Пловдив, Пазарджик, Смолян, Кърджали, Хасково, Стара Загора)</option>
                        <option value="Югоизточен">Югоизточен (Бургас, Ямбол)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="honeyFilter">Филтрирай по вид мед:</label>
                    <select id="honeyFilter">
                        <option value="">Всички видове мед</option>
                        <option value="Акациев">Акациев мед</option>
                        <option value="Липов">Липов мед</option>
                        <option value="Слънчогледов">Слънчогледов мед</option>
                        <option value="Билков">Билков мед</option>
                    </select>
                </div>
                <div class="filter-group" style="flex: 0 0 auto; display: flex; gap: 0.5rem;">
                    <button type="button" class="search-btn" onclick="updateMapMarkers()">Търси</button>
                    <button type="button" class="clear-filters-btn" onclick="clearFilters()">Изчисти филтри</button>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map" style="background: #e9ecef; display: flex; align-items: center; justify-content: center; color: #666;">
                Loading map...
            </div>
        </div>
    </div>
</div>

<script>
    // Handle Google Maps API key
    const apiKey = '@Model.GoogleMapsApiKey';
    console.log('=== MAP DEBUG ===');
    console.log('API Key loaded:', apiKey ? 'YES (length: ' + apiKey.length + ')' : 'NO');
    console.log('API Key value:', apiKey);
    
    let mapsLoaded = false;

    if (apiKey && apiKey.trim() !== '') {
        console.log('Loading Google Maps script...');
        // Load Google Maps with API key
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=places`;
        script.async = true;
        script.defer = true;
        script.onload = function() {
            console.log('Google Maps script loaded successfully');
        };
        script.onerror = function() {
            console.error('Failed to load Google Maps script');
            document.getElementById('map').innerHTML = '<div style="padding: 2rem; text-align: center;"><p>Failed to load Google Maps. Please check your API key and browser console for errors.</p></div>';
        };
        document.head.appendChild(script);
    } else {
        console.log('No API key configured, showing placeholder');
        // Show a placeholder if no API key is configured
        document.getElementById('map').innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; border-radius: 10px;">
                <div style="text-align: center; padding: 2rem;">
                    <h3>Google Maps API Key Required</h3>
                    <p>To use this interactive map, please configure your Google Maps API key.</p>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
                        Add <code>GoogleMaps:ApiKey</code> to your appsettings.json<br/>
                        or set the <code>GOOGLE_MAPS_API_KEY</code> environment variable.
                    </p>
                    <p style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">
                        Get your API key at: <a href="https://console.cloud.google.com/google/maps-apis" target="_blank">Google Cloud Console</a>
                    </p>
                </div>
            </div>
        `;
    }
</script>

<script>
    let map;
    let markers = [];
    let allBeekeepers = @Html.Raw(Json.Serialize(Model.Beekeepers));

    function initMap() {
        console.log('=== initMap() CALLED ===');
        console.log('Beekeepers count:', allBeekeepers.length);
        console.log('Map element exists:', document.getElementById('map') !== null);
        
        // Default center on Bulgaria
        map = new google.maps.Map(document.getElementById('map'), {
            mapId: '70f408e50f3bb9a450022c50', // Custom map style
            center: { lat: 42.7339, lng: 25.4858 },
            zoom: 7,
            mapTypeControl: true,
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                position: google.maps.ControlPosition.TOP_RIGHT
            },
            streetViewControl: false,
            fullscreenControl: true
        });

        // Add markers for all beekeepers
        allBeekeepers.forEach(beekeeper => {
            // Create custom icon - location pin with bee
            const customIcon = {
                path: 'M12 0C5.373 0 0 5.373 0 12c0 8.016 12 20 12 20s12-11.984 12-20C24 5.373 18.627 0 12 0zm0 11c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3z',
                fillColor: '#F59F0A',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 2,
                scale: 1.5,
                anchor: new google.maps.Point(12, 20),
                labelOrigin: new google.maps.Point(12, 14)
            };

            const marker = new google.maps.Marker({
                position: { lat: beekeeper.latitude, lng: beekeeper.longitude },
                map: map,
                title: beekeeper.fullName,
                icon: customIcon,
                label: {
                    text: '🐝',
                    fontSize: '14px',
                    fontWeight: 'bold'
                }
            });

            // Create info window
            const infoWindow = new google.maps.InfoWindow({
                content: createInfoWindowContent(beekeeper)
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });

            markers.push({
                marker: marker,
                beekeeper: beekeeper
            });
        });
    }

    function createInfoWindowContent(beekeeper) {
        const honeyTypesHtml = beekeeper.honeyTypes && beekeeper.honeyTypes.length > 0
            ? `<div class="honey-types">${beekeeper.honeyTypes.map(type => `<span class="honey-type-badge">${type}</span>`).join('')}</div>`
            : '';

        return `
            <div class="beekeeper-info-window">
                <h3>${escapeHtml(beekeeper.fullName)}</h3>
                <p><strong>Регион:</strong> ${escapeHtml(beekeeper.region || 'България')}</p>
                ${honeyTypesHtml}
                <a href="${beekeeper.profileUrl}" target="_blank">Виж профил →</a>
            </div>
        `;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Filter functionality
    function updateMapMarkers() {
        const regionFilter = document.getElementById('regionFilter').value.toLowerCase();
        const honeyFilter = document.getElementById('honeyFilter').value.toLowerCase();

        markers.forEach(markerItem => {
            const beekeeper = markerItem.beekeeper;
            const regionMatch = !regionFilter || beekeeper.region?.toLowerCase().includes(regionFilter);
            const honeyMatch = !honeyFilter || 
                (beekeeper.honeyTypes && beekeeper.honeyTypes.some(type => 
                    type.toLowerCase().includes(honeyFilter)
                ));

            if (regionMatch && honeyMatch) {
                markerItem.marker.setVisible(true);
            } else {
                markerItem.marker.setVisible(false);
            }
        });

        // Adjust bounds to show visible markers
        const bounds = new google.maps.LatLngBounds();
        let hasVisibleMarkers = false;

        markers.forEach(markerItem => {
            if (markerItem.marker.getVisible()) {
                bounds.extend(markerItem.marker.getPosition());
                hasVisibleMarkers = true;
            }
        });

        if (hasVisibleMarkers) {
            map.fitBounds(bounds);
        } else {
            // If no markers visible, center on Bulgaria
            map.setCenter({ lat: 42.7339, lng: 25.4858 });
            map.setZoom(7);
        }
    }

    function clearFilters() {
        document.getElementById('regionFilter').value = '';
        document.getElementById('honeyFilter').value = '';
        updateMapMarkers();
    }

    // Note: Filters now require clicking "Търси" button to apply
    // Event listeners removed to allow manual search trigger
</script>

