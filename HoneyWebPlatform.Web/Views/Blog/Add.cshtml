@model HoneyWebPlatform.Web.ViewModels.Blog.PostFormModel
@{
    ViewData["Title"] = "Добави Пост";
}

<h2 class="text-center">@ViewData["Title"]</h2>
<hr />

<partial name="_PostFormPartial" model="@Model" />

@section Scripts
{
    <partial name="_ValidationScriptsPartial" />

    <script>
        let isSubmitting = false; // Prevent multiple submissions
        
        function updateFileName(input) {
            console.log('updateFileName called for post');
            console.log('input:', input);
            console.log('input.files:', input.files);
            
            if (input.files && input.files.length > 0) {
                var fileName = input.files[0].name;
                var fileSize = input.files[0].size;
                var maxSize = 2 * 1024 * 1024; // 2MB
                
                console.log('Selected file:', fileName, 'Size:', fileSize, 'bytes');
                
                var fileInfoElement = document.getElementById('upload-file-info');
                if (fileInfoElement) {
                    if (fileSize > maxSize) {
                        fileInfoElement.value = 'Файлът е твърде голям! Максимум 2MB';
                        fileInfoElement.style.color = 'red';
                        input.value = ''; // Clear the file input
                    } else {
                        fileInfoElement.value = fileName + ' (' + Math.round(fileSize / 1024) + ' KB)';
                        fileInfoElement.style.color = 'green';
                    }
                } else {
                    console.error('upload-file-info element not found');
                }
            } else {
                console.log('No file selected');
                var fileInfoElement = document.getElementById('upload-file-info');
                if (fileInfoElement) {
                    fileInfoElement.value = '';
                    fileInfoElement.style.color = '';
                }
            }
        }
        
        // Add event listener to ensure the function is called
        document.addEventListener('DOMContentLoaded', function() {
            var fileInput = document.getElementById('PostPicture');
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    updateFileName(this);
                });
            }
            
            // Add form validation feedback
            var form = document.getElementById('post-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    // Prevent multiple submissions
                    if (isSubmitting) {
                        e.preventDefault();
                        console.log('Form submission prevented - already submitting');
                        return false;
                    }
                    
                    var errors = [];
                    
                    // Check required text fields
                    var title = document.querySelector('input[name="Title"]');
                    if (!title.value.trim()) {
                        errors.push('Моля въведете наименование!');
                    }
                    
                    var content = document.querySelector('textarea[name="Content"]');
                    if (!content.value.trim()) {
                        errors.push('Моля въведете съдържание!');
                    }
                    
                    // Check file input (optional)
                    var fileInput = document.getElementById('PostPicture');
                    if (fileInput.files && fileInput.files.length > 0) {
                        var file = fileInput.files[0];
                        var maxSize = 2 * 1024 * 1024; // 2MB
                        if (file.size > maxSize) {
                            errors.push('Файлът е твърде голям! Максималният размер е 2MB.');
                        }
                    }
                    
                    if (errors.length > 0) {
                        e.preventDefault();
                        alert('Моля поправете следните грешки:\n\n' + errors.join('\n'));
                        return false;
                    }
                    
                    // Mark as submitting and disable submit button
                    isSubmitting = true;
                    var submitButton = form.querySelector('input[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.value = 'Запазване...';
                    }
                    
                    console.log('Form submitting...');
                });
            }
        });
    </script>
}